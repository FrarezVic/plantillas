'use strict';
const actualizaDynamo = require('../dao/actualiza');
const valSchema = require('../validaciones/validadorEsquema');
const esquema = require('../recursos/schema.json').actualizar;
<% if (lambda_eods_enviar) { _%>
const invocaLambda = require('../servicios/invocaLambda');
const EVENTTYPE = "<%=lambda_eods_event%>";
<% } _%>
const headers = {
    "Access-Control-Allow-Origin": "*"
};

module.exports.actualizar = async (event) => {
    try {
        let req;

        if (event.headers) {
            req = JSON.parse(event.body);
        } else {
            req = event;
        }

        console.log('Request:' + JSON.stringify(req));

        await valSchema(req, esquema);

        let parametros = {
<% atributos.forEach(function(atributo){ _%>
            <%= atributo.nombre %>: req.<%= atributo.nombre _%>,
<% }); _%>
        };

        let respuesta = await actualizaDynamo(process.env.DYNAMODB_TABLE, 'id', event.pathParameters.id, parametros);

        console.log(JSON.stringify(respuesta));
<% if (lambda_eods_enviar) { _%>

        // enviar a EODS
        let payload_eods = {
            event_type: EVENTTYPE,
            message: respuesta
        };
        await invocaLambda(process.env.LAMBDA_MENSAJE_ODS, payload_eods);

<% } _%>
        return {
            statusCode: 200,
          	headers: headers,
            body: JSON.stringify(respuesta),
        };
    } catch (e) {
        console.log('Error en handler: ' + JSON.stringify(e));
        console.log('Mensaje de error: ' + e.message);
        let error = e.body || e;
        return {
            statusCode: e.statusCode || 500,
          	headers: headers,
            body: JSON.stringify(error)
        }
    }
};
