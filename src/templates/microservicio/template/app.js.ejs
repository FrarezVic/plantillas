var express = require('express');
var bodyParser = require('body-parser');
var app = express();
var routes = require('./rutas');
var morgan = require('morgan');
var puerto = process.env.port || 8080;
var swaggerUi = require('swagger-ui-express');
var swaggerDocument = require('./swagger.json');
var cors = require('cors');
var uuid = require('uuid');
var httpContext = require('express-http-context');
var logger = require("./funciones/utilerias/logger");

app.use(cors());
app.use(bodyParser.json());
app.use(bodyParser.urlencoded({ extended: true }));
app.disable('x-powered-by');
app.use(httpContext.middleware);

app.use(function (req, res, next) {
    var uuidReq = req.headers.id_tracking ? req.headers.id_tracking : uuid.v1();
    res.setHeader('id_tracking', uuidReq);
    httpContext.set('id_tracking', uuidReq);
    httpContext.set('nombre_aplicativo', req.headers.nombre_aplicativo);
    httpContext.set('identificador_usuario', req.headers.identificador_usuario);
    next();
});

morgan.token('header', function (req, res) { return JSON.stringify(req.headers)});
morgan.token('body', function (req, res) { return JSON.stringify(req.body)});
app.use(morgan(':status ":method :url"  :req[header] :header :body', { stream: logger.stream }))

app.get('/', (req, res) => res.send('<%= micro_descripcion %>'));

app.use('<%=micro_url_principal%>', routes);

app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(swaggerDocument));

app.listen(puerto, () => console.log('<%= micro_descripcion %>: ' + puerto))

module.exports = {
    app
};